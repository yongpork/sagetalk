# 클라우드 백업 개선 계획

> **작성일**: 2025년 9월 21일  
> **문제점**: 내 컴퓨터가 꺼진 상태에서는 대화 기록이 저장되지 않음  
> **목표**: 클라우드 기반 대화 저장 시스템 구축

---

## 🚨 현재 문제점

### ❌ **기존 시스템의 한계**
- **로컬 파일 저장**: 내 컴퓨터 파일 시스템에만 저장
- **컴퓨터 종료 시**: 대화 기록 저장 불가능
- **데이터 손실 위험**: 하드웨어 장애 시 대화 기록 소실
- **접근성 문제**: 다른 기기에서 대화 기록 확인 불가

### 🔍 **현재 저장 과정**
```
사용자 대화 → Vercel 서버 → 내 컴퓨터 파일 시스템 → 저장
                    ↑
              내 컴퓨터가 꺼지면 여기서 중단!
```

---

## 💡 해결 방안

### **방안 1: Vercel KV (Redis) 사용** ⭐ **추천**

**장점:**
- Vercel 생태계와 완벽 통합
- 무료 티어 제공 (월 1GB)
- 빠른 읽기/쓰기 성능
- 자동 백업 및 복제

**구현 방법:**
```javascript
// 1. Vercel KV 설정
import { kv } from '@vercel/kv';

// 2. 대화 저장
await kv.set(`conversation:${roomId}:${timestamp}`, {
  content: conversationContent,
  timestamp: new Date().toISOString(),
  aiModel: aiModel
});

// 3. 대화 불러오기
const conversations = await kv.lrange(`conversation:${roomId}`, 0, -1);
```

**비용:**
- 무료 티어: 월 1GB 저장, 30,000 요청
- 유료 플랜: $0.50/GB/월

### **방안 2: Supabase (PostgreSQL)** ⭐ **추천**

**장점:**
- 완전 무료 티어 (월 500MB, 50,000 요청)
- PostgreSQL 기반 (강력한 쿼리 기능)
- 실시간 구독 기능
- 웹 대시보드 제공

**구현 방법:**
```javascript
// 1. Supabase 클라이언트 설정
import { createClient } from '@supabase/supabase-js';

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_ANON_KEY
);

// 2. 대화 저장
await supabase.from('conversations').insert({
  room_id: roomId,
  content: conversationContent,
  timestamp: new Date().toISOString(),
  ai_model: aiModel
});

// 3. 대화 불러오기
const { data } = await supabase
  .from('conversations')
  .select('*')
  .eq('room_id', roomId)
  .order('timestamp', { ascending: false });
```

### **방안 3: Firebase Firestore**

**장점:**
- Google 클라우드 기반
- 실시간 동기화
- 강력한 쿼리 기능

**단점:**
- 무료 티어 제한 (월 50,000 읽기, 20,000 쓰기)
- 복잡한 설정

### **방안 4: GitHub API 활용**

**장점:**
- 이미 GitHub 저장소 사용 중
- 추가 비용 없음
- 버전 관리 자동화

**단점:**
- API 호출 제한 (시간당 5,000회)
- 복잡한 데이터 구조

---

## 🛠️ 구현 계획

### **Phase 1: Vercel KV 도입** (1-2일)

1. **Vercel KV 설정**
   ```bash
   npm install @vercel/kv
   ```

2. **환경 변수 설정**
   ```
   KV_REST_API_URL=your_kv_url
   KV_REST_API_TOKEN=your_kv_token
   ```

3. **API 수정**
   ```javascript
   // save-conversation/route.ts 수정
   import { kv } from '@vercel/kv';
   
   // 클라우드 저장 추가
   await kv.set(`conv:${roomId}:${Date.now()}`, {
     content: contentWithSeparator,
     timestamp: new Date().toISOString()
   });
   ```

### **Phase 2: 하이브리드 저장 시스템** (3-4일)

1. **로컬 + 클라우드 이중 저장**
   ```javascript
   try {
     // 1. 로컬 저장 (기존)
     await fs.appendFile(filePath, content, 'utf8');
     
     // 2. 클라우드 저장 (신규)
     await kv.set(`backup:${roomId}`, content);
     
   } catch (error) {
     // 로컬 실패 시 클라우드에서 복구
     const backup = await kv.get(`backup:${roomId}`);
   }
   ```

2. **동기화 기능**
   ```javascript
   // 주기적으로 로컬과 클라우드 동기화
   setInterval(async () => {
     await syncLocalToCloud();
   }, 300000); // 5분마다
   ```

### **Phase 3: 완전 클라우드 전환** (5-7일)

1. **로컬 의존성 제거**
2. **클라우드 우선 저장**
3. **백업 시스템 구축**

---

## 📊 성능 및 비용 분석

### **Vercel KV**
- **저장 용량**: 1GB (무료) → 약 100만 대화
- **응답 시간**: 1-5ms
- **비용**: 무료 (월 30,000 요청까지)

### **Supabase**
- **저장 용량**: 500MB (무료) → 약 50만 대화
- **응답 시간**: 10-50ms
- **비용**: 무료 (월 50,000 요청까지)

### **현재 시스템 (로컬 파일)**
- **저장 용량**: 무제한 (하드디스크 용량에 따라)
- **응답 시간**: 1-10ms
- **비용**: 무료 (하지만 안정성 문제)

---

## 🚀 즉시 실행 가능한 해결책

### **임시 해결책: GitHub 자동 커밋**

```javascript
// 대화 저장 시 자동으로 GitHub에 커밋
const { exec } = require('child_process');

async function autoCommitToGit() {
  exec('git add . && git commit -m "Auto-save conversation" && git push origin main', 
    (error, stdout, stderr) => {
      if (error) console.error('Git commit failed:', error);
    }
  );
}
```

**장점:**
- 즉시 구현 가능
- 추가 비용 없음
- GitHub에 백업됨

**단점:**
- Git 커밋 제한 (너무 자주 커밋하면 제한)
- 복잡한 대화 구조

---

## 📋 구현 체크리스트

### **Phase 1 체크리스트**
- [ ] Vercel KV 계정 생성
- [ ] 환경 변수 설정
- [ ] `@vercel/kv` 패키지 설치
- [ ] API 코드 수정
- [ ] 테스트 및 검증

### **Phase 2 체크리스트**
- [ ] 하이브리드 저장 로직 구현
- [ ] 에러 핸들링 추가
- [ ] 동기화 기능 구현
- [ ] 성능 테스트

### **Phase 3 체크리스트**
- [ ] 로컬 의존성 완전 제거
- [ ] 클라우드 우선 저장 전환
- [ ] 백업 및 복구 시스템 구축
- [ ] 모니터링 시스템 구축

---

## 💡 추가 개선 사항

### **1. 실시간 동기화**
```javascript
// WebSocket을 통한 실시간 대화 동기화
const ws = new WebSocket('wss://api.vercel.com/conversations');
```

### **2. 대화 검색 기능**
```javascript
// 클라우드에서 대화 내용 검색
const results = await kv.scan(0, { match: `*${searchTerm}*` });
```

### **3. 대화 분석 기능**
```javascript
// 대화 패턴 분석 및 인사이트 제공
const analytics = await analyzeConversations(roomId);
```

---

**마지막 업데이트**: 2025년 9월 21일  
**우선순위**: 높음 (데이터 손실 방지)  
**예상 완료일**: 2025년 9월 28일
